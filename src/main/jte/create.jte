@import java.util.List
@import java.time.format.DateTimeFormatter
@import dev.jotxee.secretsanta.entity.Sorteo
@param List<Sorteo> sorteos
@param String success = null
@param String error = null

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crear Sorteo - Secret Santa</title>
  <link rel="stylesheet" href="/css/admin.css">
</head>
<body>
  <div class="admin-container">
    <header class="admin-header">
      <h1>ğŸ„ Panel de AdministraciÃ³n - Secret Santa</h1>
      <a href="/" class="btn-back">â† Volver al inicio</a>
    </header>

    <main class="admin-content">
      <!-- Mensajes de Ã©xito/error -->
      @if(success != null)
        <div class="alert alert-success">
          âœ… ${success}
        </div>
      @endif
      
      @if(error != null)
        <div class="alert alert-error">
          âŒ ${error}
        </div>
      @endif

      <!-- SecciÃ³n: Crear Nuevo Sorteo -->
      <section class="create-section">
        <h2>âœ¨ Crear Nuevo Sorteo</h2>
        <form action="/create" method="post" class="create-form">
          <div class="form-group">
            <label for="sorteoNombre">Nombre del Sorteo (visible para participantes)</label>
            <input type="text" id="sorteoNombre" name="nombre" required 
                   placeholder="Ej: Amigo Invisible Familia 2025">
            <small>Este nombre aparecerÃ¡ en los emails y en la pÃ¡gina de reveal</small>
          </div>

          <div class="form-group">
            <label for="sorteoNombreInterno">Nombre Interno (para administraciÃ³n)</label>
            <input type="text" id="sorteoNombreInterno" name="nombreInterno" 
                   placeholder="Ej: Amigo invisible navidad 2025 familia SÃ¡nchez">
            <small>Nombre histÃ³rico para referencias aÃ±o tras aÃ±o. Opcional.</small>
          </div>

          <div class="form-group">
            <label>Importe del Regalo</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
              <div>
                <input type="number" name="importeMinimo" step="0.01" min="0" 
                       placeholder="MÃ­nimo (â‚¬)" style="width: 100%;">
              </div>
              <div>
                <input type="number" name="importeMaximo" step="0.01" min="0" 
                       placeholder="MÃ¡ximo (â‚¬)" style="width: 100%;">
              </div>
            </div>
            <small>Define la franja de precio del regalo. Ambos campos son opcionales.</small>
          </div>

          <div class="participants-section">
            <h3>Participantes</h3>
            <div id="participantsList">
              <div class="participant-row">
                <input type="text" name="participantes[0].nombre" required placeholder="Nombre del participante">
                <input type="email" name="participantes[0].email" required placeholder="email@ejemplo.com">
                <div class="gender-select">
                  <label><input type="radio" name="participantes[0].genero" value="hombre"> ğŸ‘¨ Hombre</label>
                  <label><input type="radio" name="participantes[0].genero" value="mujer"> ğŸ‘© Mujer</label>
                </div>
                <button type="button" class="btn-remove" onclick="removeParticipant(this)">ğŸ—‘ï¸</button>
              </div>
              <div class="participant-row">
                <input type="text" name="participantes[1].nombre" required placeholder="Nombre del participante">
                <input type="email" name="participantes[1].email" required placeholder="email@ejemplo.com">
                <div class="gender-select">
                  <label><input type="radio" name="participantes[1].genero" value="hombre"> ğŸ‘¨ Hombre</label>
                  <label><input type="radio" name="participantes[1].genero" value="mujer"> ğŸ‘© Mujer</label>
                </div>
                <button type="button" class="btn-remove" onclick="removeParticipant(this)">ğŸ—‘ï¸</button>
              </div>
              <div class="participant-row">
                <input type="text" name="participantes[2].nombre" required placeholder="Nombre del participante">
                <input type="email" name="participantes[2].email" required placeholder="email@ejemplo.com">
                <div class="gender-select">
                  <label><input type="radio" name="participantes[2].genero" value="hombre"> ğŸ‘¨ Hombre</label>
                  <label><input type="radio" name="participantes[2].genero" value="mujer"> ğŸ‘© Mujer</label>
                </div>
                <button type="button" class="btn-remove" onclick="removeParticipant(this)">ğŸ—‘ï¸</button>
              </div>
            </div>
            <button type="button" class="btn-add" onclick="addParticipant()">+ AÃ±adir Participante</button>
          </div>

          <button type="submit" class="btn-submit">ğŸ Crear Sorteo y Enviar Emails</button>
        </form>
      </section>

      <!-- SecciÃ³n: Sorteos Activos -->
      <section class="sorteos-section">
        <h2>ğŸ“‹ Sorteos Activos</h2>
        
        @if(sorteos.isEmpty())
          <p class="empty-message">No hay sorteos activos. Â¡Crea uno arriba!</p>
        @else
          @for(var sorteo : sorteos)
            !{var formatter = DateTimeFormatter.ofPattern("dd/MM/yyyy HH:mm");}
            <div class="sorteo-card">
              <div class="sorteo-header">
                <div>
                  <h3>${sorteo.getNombre()}</h3>
                  @if(sorteo.getNombreInterno() != null && !sorteo.getNombreInterno().isEmpty())
                    <span class="sorteo-internal-name">ğŸ“ ${sorteo.getNombreInterno()}</span>
                  @endif
                  @if(sorteo.getImporteMinimo() != null || sorteo.getImporteMaximo() != null)
                    <span class="sorteo-price">
                      ğŸ’° 
                      @if(sorteo.getImporteMinimo() != null && sorteo.getImporteMaximo() != null)
                        ${sorteo.getImporteMinimo()}â‚¬ - ${sorteo.getImporteMaximo()}â‚¬
                      @elseif(sorteo.getImporteMinimo() != null)
                        Desde ${sorteo.getImporteMinimo()}â‚¬
                      @else
                        Hasta ${sorteo.getImporteMaximo()}â‚¬
                      @endif
                    </span>
                  @endif
                  <span class="sorteo-date">Creado: ${sorteo.getFechaCreacion().format(formatter)}</span>
                </div>
                <button class="btn-delete-sorteo" onclick="deleteSorteo(${sorteo.getId()})">
                  ğŸ—‘ï¸ Eliminar
                </button>
              </div>
              
              <div class="participants-list">
                <h4>Participantes (${sorteo.getParticipantes().size()})</h4>
                @for(var participante : sorteo.getParticipantes())
                  <div class="participant-item">
                    <div class="participant-info">
                      <span class="participant-name">ğŸ‘¤ ${participante.getNombre()}</span>
                      <span class="participant-email">ğŸ“§ ${participante.getEmail()}</span>
                      @if(participante.getAsignadoA() != null && !participante.getAsignadoA().isEmpty())
                        <span class="participant-assigned">ğŸ â†’ ${participante.getAsignadoAEncrypted()}</span>
                      @else
                        <span class="participant-assigned">ğŸ â†’ Sin asignar</span>
                      @endif
                    </div>
                    <div class="participant-actions">
                      <button class="btn-edit" onclick="editEmail(${participante.getId()}, '${participante.getEmail()}')">
                        âœï¸ Editar Email
                      </button>
                      <button class="btn-resend" onclick="resendEmail(${participante.getId()})">
                        ğŸ“¨ Reenviar
                      </button>
                    </div>
                  </div>
                @endfor
              </div>
            </div>
          @endfor
        @endif
      </section>
    </main>
  </div>

  <script>
    let participantIndex = 3;

    function addParticipant() {
      const list = document.getElementById('participantsList');
      const row = document.createElement('div');
      row.className = 'participant-row';
      row.innerHTML = '<input type="text" name="participantes[' + participantIndex + '].nombre" required placeholder="Nombre del participante">' +
        '<input type="email" name="participantes[' + participantIndex + '].email" required placeholder="email@ejemplo.com">' +
        '<div class="gender-select">' +
        '<label><input type="radio" name="participantes[' + participantIndex + '].genero" value="hombre"> ğŸ‘¨ Hombre</label>' +
        '<label><input type="radio" name="participantes[' + participantIndex + '].genero" value="mujer"> ğŸ‘© Mujer</label>' +
        '</div>' +
        '<button type="button" class="btn-remove" onclick="removeParticipant(this)">ğŸ—‘ï¸</button>';
      list.appendChild(row);
      participantIndex++;
    }

    function removeParticipant(button) {
      const list = document.getElementById('participantsList');
      if (list.children.length > 3) {
        button.parentElement.remove();
      } else {
        alert('Debe haber al menos 3 participantes');
      }
    }

    function editEmail(participanteId, currentEmail) {
      const newEmail = prompt('Nuevo email:', currentEmail);
      if (newEmail && newEmail !== currentEmail) {
        fetch('/api/participante/' + participanteId + '/email', {
          method: 'PUT',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({email: newEmail})
        })
        .then(response => response.ok ? location.reload() : alert('Error al actualizar'))
        .catch(() => alert('Error de conexiÃ³n'));
      }
    }

    function resendEmail(participanteId) {
      if (confirm('Â¿Reenviar email a este participante?')) {
        fetch('/api/participante/' + participanteId + '/resend', {method: 'POST'})
        .then(response => response.ok ? alert('Email enviado!') : alert('Error al enviar'))
        .catch(() => alert('Error de conexiÃ³n'));
      }
    }

    function deleteSorteo(sorteoId) {
      if (confirm('Â¿EstÃ¡s seguro de eliminar este sorteo?\n\nEsta acciÃ³n eliminarÃ¡ el sorteo y todos sus participantes.')) {
        // Crear un formulario oculto para hacer DELETE via POST
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/sorteo/' + sorteoId;
        
        // AÃ±adir campo hidden para simular DELETE (Spring soporta _method)
        const methodInput = document.createElement('input');
        methodInput.type = 'hidden';
        methodInput.name = '_method';
        methodInput.value = 'DELETE';
        form.appendChild(methodInput);
        
        document.body.appendChild(form);
        form.submit();
      }
    }
  </script>
</body>
</html>
